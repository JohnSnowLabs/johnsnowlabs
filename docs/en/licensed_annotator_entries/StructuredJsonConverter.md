{%- capture title -%}
StructuredJsonConverter
{%- endcapture -%}

{%- capture model -%}
model
{%- endcapture -%}

{%- capture model_description -%}
This annotator integrates seamlessly with existing systems to process outputs from pretrained pipelines, delivering structured, easy-to-read results in a dictionary format. 
Optimized for API integration and user-friendly outputs, it supports streamlined data analysis workflows by converting raw annotations into a prettified, structured JSON format.
With configurable schema mappings, it accommodates diverse outputs, including entities, assertions, resolutions, relations, summaries, deidentifications, and classifications. 
It uses column_maps to define output columns and align them with pipeline requirements. It handles diverse annotation types, including entities, assertions, resolutions, relations, summaries, deidentifications, and classifications.
It produces well-structured, easy-to-read results ideal for API consumption and streamlined workflows.

Parameters:

- `cleanAnnotations`: Whether to remove annotation columns, by default False.
- `returnRelationEntities`: Whether to return the entities in the relations or not, by default False.
- `outputAsStr`:  Whether to output the result as a string or as a structured json, by default True.

```
When set to `True`, the output column will be a string:

|-- column_name: string (nullable = true)

When set to False, the output column will be a struct with the following schema:

|-- column_name: struct (nullable = true)
      |-- document_identifier: string (nullable = true)
      |-- document_text: array (nullable = true)
      |    |-- element: string (containsNull = true)
      |-- entities: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)
      |-- assertions: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)
      |-- resolutions: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)
      |-- relations: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)
      |-- summaries: array (nullable = true)
      |    |-- element: string (containsNull = true)
      |-- deidentifications: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)
      |-- classifications: array (nullable = true)
      |    |-- element: map (containsNull = true)
      |        |-- key: string
      |        |-- value: string (valueContainsNull = true)

```

- `converterSchema` and `converterSchemaAsStr`: The schema for converting the output of the pipeline into a structured JSON format. Fields in the schema:
  - `document_identifier`: The identifier of the document. This column must be of type `StringType`.
  - `document_text`: The text of the document, typically created by the `DocumentAssembler` annotator.
  - `entities`: Chunk columns generated by various annotators, such as the `ChunkMergeModel` annotator.
  - `assertions`: Assertion columns produced by annotators like the `AssertionDLModel` annotator.
  - `resolutions`: The schema for resolutions. See `ResolutionSchema` for details.
  - `relations`: Relation columns created by annotators such as the `RelationExtractionModel` annotator.
  - `summaries`: Summary columns generated by annotators like the `MedicalSummarizer` annotator.
  - `deidentifications`: The schema for deidentifications.
  - `classifications`: The schema for classifications.
  
{%- endcapture -%}

{%- capture model_input_anno -%}


{%- endcapture -%}

{%- capture model_input_anno -%}
ANY
{%- endcapture -%}

{%- capture model_output_anno -%}
JSON
{%- endcapture -%}

{%- capture model_python_medical -%}

from johnsnowlabs import nlp, medical
from sparknlp_jsl.pipeline_tracer import PipelineTracer

oncology_pipeline = nlp.PretrainedPipeline("explain_clinical_doc_oncology", "en", "clinical/models")

text = """The Patient underwent a computed tomography (CT) scan of the abdomen and pelvis, which showed a complex ovarian mass. A Pap smear performed one month later was positive for atypical glandular cells suspicious for adenocarcinoma. The pathologic specimen showed extension of the tumor throughout the fallopian tubes, appendix, omentum, and 5 out of 5 enlarged lymph nodes. The final pathologic diagnosis of the tumor was stage IIIC papillary serous ovarian adenocarcinoma. Two months later, the patient was diagnosed with lung metastases.Neoadjuvant chemotherapy with the regimens of Cyclophosphamide (500 mg/m2) is being given for 6 cycles with poor response"""

data = spark.createDataFrame([[text]]).toDF("text")

result_df = oncology_pipeline.transform(data)

pipeline_tracer = PipelineTracer(oncology_pipeline)

column_maps = pipeline_tracer.createParserDictionary()

output_converter = StructuredJsonConverter()\
    .setOutputCol("result")\
    .setConverterSchema(column_maps)\
    .setCleanAnnotations(False)\
    .setReturnRelationEntities(True)\
    .setOutputAsStr(True)

json_output = output_converter.transform(result_df).select("result")

json_output.show(truncate=200)

# result

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|result                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|{"result":{"document_identifier":"fc43295f-cbbe-4ca9-b842-abb1c2fc017e","document_text":["The Patient underwent a computed tomography (CT) scan of the abdomen and pelvis, which showed a complex ova...|
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
{%- endcapture -%}


{%- capture model_scala_medical -%}

import spark.implicits._
import com.johnsnowlabs.nlp.pretrained.PretrainedPipeline
import com.johnsnowlabs.util.tracer.PipelineTracer

val oncology_pipeline = PretrainedPipeline("explain_clinical_doc_oncology", "en", "clinical/models")

val text = """The Patient underwent a computed tomography (CT) scan of the abdomen and pelvis, which showed a complex ovarian mass. A Pap smear performed one month later was positive for atypical glandular cells suspicious for adenocarcinoma. The pathologic specimen showed extension of the tumor throughout the fallopian tubes, appendix, omentum, and 5 out of 5 enlarged lymph nodes. The final pathologic diagnosis of the tumor was stage IIIC papillary serous ovarian adenocarcinoma. Two months later, the patient was diagnosed with lung metastases.Neoadjuvant chemotherapy with the regimens of Cyclophosphamide (500 mg/m2) is being given for 6 cycles with poor response"""

val data = Seq(text).toDF("text")

val result_df  = oncology_pipeline.transform(data)

val pipeline_tracer = new PipelineTracer(oncology_pipeline)

val column_maps = pipeline_tracer.createParserDictionary()

val output_converter = new StructuredJsonConverter()
  .setOutputCol("result")
  .setConverterSchemaAsStr(column_maps)
  .setCleanAnnotations(false)
  .setReturnRelationEntities(true)
  .setOutputAsStr(true)

val json_output = output_converter.transform(result_df).select("result")

json_output.show()

# result
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|result                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|{"result":{"document_identifier":"fc43295f-cbbe-4ca9-b842-abb1c2fc017e","document_text":["The Patient underwent a computed tomography (CT) scan of the abdomen and pelvis, which showed a complex ova...|
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

{%- endcapture -%}

{%- capture model_api_link -%}
[StructuredJsonConverter](https://nlp.johnsnowlabs.com/licensed/api/com/johnsnowlabs/nlp/annotators/parser/StructuredJsonConverter.html)
{%- endcapture -%}

{%- capture model_python_api_link -%}
[StructuredJsonConverter](https://nlp.johnsnowlabs.com/licensed/api/python/reference/autosummary/sparknlp_jsl/annotator/parser/StructuredJsonConverter/index.html)
{%- endcapture -%}

{%- capture model_notebook_link -%}
[StructuredJsonConverter](https://github.com/JohnSnowLabs/spark-nlp-workshop/blob/master/Spark_NLP_Udemy_MOOC/Healthcare_NLP/StructuredJsonConverter.ipynb)
{%- endcapture -%}

{% include templates/licensed_approach_model_medical_fin_leg_template.md
title=title
model=model
model_description=model_description
model_input_anno=model_input_anno
model_output_anno=model_output_anno
model_python_medical=model_python_medical
model_scala_medical=model_scala_medical
model_api_link=model_api_link
model_python_api_link=model_python_api_link
model_notebook_link=model_notebook_link
%}
