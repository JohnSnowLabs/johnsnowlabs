FROM ubuntu:20.04
ENV PYSPARK_PYTHON=python3
ENV PYSPARK_DRIVER_PYTHON=python3
ENV DEBIAN_FRONTEND noninteractive
ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64/
RUN export JAVA_HOME
RUN echo "export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/" >> ~/.bashrc
ENV LC_ALL=C.UTF-8 LANG=C.UTF-8


RUN apt-get update && apt-get install -y \
         python3 \
         python3-dev \
         python3-pip \
         wget \
         openjdk-8-jdk \
         git-core

RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Add Tini
ADD https://github.com/krallin/tini/releases/download/v0.19.0/tini /usr/local/bin/tini
RUN chmod +x /usr/local/bin/tini


# Set install and license env vars
ENV JOHNSNOWLABS_LICENSE=""$JOHNSNOWLABS_LICENSE$""
ENV MEDICAL_SECRET=""$MEDICAL_SECRET$""
ENV VISUAL_SECRET=""$VISUAL_SECRET$""
ENV JOHNSNOWLABS_AWS_ACCESS_KEY_ID=""$JOHNSNOWLABS_AWS_ACCESS_KEY_ID$""
ENV JOHNSNOWLABS_AWS_SECRET_ACCESS_KEY=""$JOHNSNOWLABS_AWS_SECRET_ACCESS_KEY$""
ENV HARDWARE_TARGET=""$HARDWARE_TARGET$""

# Install Johnsnowlabs libraries
RUN pip install johnsnowlabs fastapi uvicorn
COPY installer.py /installer.py
RUN python3 installer.py
RUN python3 -c "from johnsnowlabs import nlp; \
nlp_license = '????'; \
nlp_secret = '???'; \
aws_access_key_id = '???'; \
aws_secret_access_key = '???'; \
nlp.install( \
    browser_login=False, \
    force_browser=False, \
    med_license=nlp_license, \
    enterprise_nlp_secret=nlp_secret, \
    aws_key_id=aws_access_key_id, \
    aws_access_key=aws_secret_access_key, \
)"



COPY app.py /app.py

# Set the command to run your FastAPI app
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "80"]

ENTRYPOINT ["/usr/local/bin/tini", "--"]

